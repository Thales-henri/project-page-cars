<!DOCTYPE html>
<html lang="pt-Br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <title>cadastrar carro</title>
</head>
<body>
      <section class="cadastro">
    <div class="login">
      <h1>Cadastrar carro</h1>
      <div>
        <input type="text" id="marca" placeholder="Digite o marca">
      </div>
      <div>
        <input type="text" id="modelo" placeholder="Digite o Modelo">
      </div>
      <div>
        <input type="text" id="ano" placeholder="Digite o ano do carro">
      </div>
      <div>
        <input type="text" id="preco" placeholder="Digite o preço">
      </div>
      <div>
        <input type="text" id="km" placeholder="Digite a quantidade de km rodado">
      </div>
      <div>
        <textarea id="descricao" placeholder="Descrição do veículo (opcional)" rows="4"></textarea>
      </div>
      <div>
        <input type="file" id="images" accept="image/*" multiple enctype="multipart/form-data">
        <small>Selecione múltiplas imagens (máximo 10)</small>
      </div>
      <div class="buttons">
      <button  class="Cadastrar" id="botaoAcao" onclick="cadastro()">CADASTRAR</button>
      <button class="Cadastrar" onclick="voltar()">VOLTAR</button>
      </div>
    </div>
  </section>
</body>

<script>

  function voltar(){
    window.history.back()
  }
    async function cadastro() {
  const carro = {
    marca: document.getElementById("marca").value,
    modelo: document.getElementById("modelo").value,
    ano: document.getElementById("ano").value,
    preco: document.getElementById("preco").value,
    km: document.getElementById("km").value,
    descricao: document.getElementById("descricao").value,
  };

  const resposta = await fetch("http://localhost:3004/carros/cadastrar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(carro),
  });

  const data = await resposta.json();

  if (!resposta.ok) {
    alert("Erro ao cadastrar carro: " + (data.erro || "Verifique os dados."));
    console.error("Erro no cadastro dos dados:", data);
    return;
  }

  const carroId = data.id;
  console.log("ID DO CARRO CRIADO:", carroId);

  const imagens = document.getElementById("images").files;

  if (imagens.length === 0) {
    alert("Carro cadastrado, mas nenhuma imagem selecionada.");
    setTimeout(() => {
      window.location.href = "carros.html";
    }, 200);
    return;
  }

  const formData = new FormData();
  for (let i = 0; i < imagens.length; i++) {
    formData.append("imagens", imagens[i]);
  }

  const respostaUpload = await fetch(
    `http://localhost:3004/carros/upload-multiplas/${carroId}`,
    { method: "POST", body: formData }
  );

  const dataUpload = await respostaUpload.json();
  console.log("RESPOSTA:", dataUpload);

  if (respostaUpload.ok) {
    alert(`Carro e ${dataUpload.quantidade} imagens cadastrados com sucesso!`);
    setTimeout(() => {
      window.location.href = "carros.html";
    }, 200);
  } else {
    alert("Erro no upload das imagens: " + (dataUpload.erro || "Tente novamente."));
  }
}


async function carregarDadosCarro() {
    const dados = localStorage.getItem("carroEdicao");
    if (!dados) return;

    const carro = JSON.parse(dados);

    document.getElementById("marca").value = carro.marca;
    document.getElementById("modelo").value = carro.modelo;
    document.getElementById("ano").value = carro.ano;
    document.getElementById("preco").value = carro.preco;
    document.getElementById("km").value = carro.km;
    document.getElementById("descricao").value = carro.descricao || "";

    document.getElementById("botaoAcao").textContent = "Atualizar";
    document.getElementById("botaoAcao").setAttribute("onclick", "salvarCarro()");
}


async function salvarCarro() {
    const carroEdicao = localStorage.getItem("carroEdicao");

    const carro = {
        marca: document.getElementById("marca").value,
        modelo: document.getElementById("modelo").value,
        ano: document.getElementById("ano").value,
        preco: document.getElementById("preco").value,
        km: document.getElementById("km").value,
        descricao: document.getElementById("descricao").value
    };

    if (!carroEdicao) {
        await fetch("http://localhost:3004/carros/cadastrar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(carro)
        });
    } else {
        const carroObj = JSON.parse(carroEdicao);

        await fetch(`http://localhost:3004/carros/editar/${carroObj.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(carro)
        });

        const imagens = document.getElementById("images").files;
        if (imagens.length > 0) {
            const formData = new FormData();
            for (let i = 0; i < imagens.length; i++) {
                formData.append("imagens", imagens[i]);
            }

            await fetch(`http://localhost:3004/carros/upload-multiplas/${carroObj.id}`, {
                method: "POST",
                body: formData
            });
        }

        localStorage.removeItem("carroEdicao");
    }

    alert("Carro salvo com sucesso!");
    window.location.href = "carros.html";
}


document.addEventListener("DOMContentLoaded", carregarDadosCarro);

    
</script>
</html>